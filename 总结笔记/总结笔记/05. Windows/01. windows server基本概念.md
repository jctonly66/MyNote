## 一、windows Server 2012基本概念

### 1. 系统版本

| 版本       | 适用场合                                    | 主要差异                                                 | 支持客户端数量                   |
| :--------- | :------------------------------------------ | :------------------------------------------------------- | -------------------------------- |
| Datacenter | 高度虚拟化的云端环境                        | 完整功能<br />虚拟机器数量没有限制                       | 根据购买的客户端访问授权数量而定 |
| Standard   | 无虚拟化或低度虚拟化的环境                  | 完整功能<br />虚拟机器数量仅限2个                        | 根据购买的客户端访问授权数量而定 |
| Essentials | 小型企业环境                                | 部分功能不支持<br />仅支持两个处理器<br />不支持虚拟环境 | 25个用户账户                     |
| Foundation | 一般用途的经济环境<br />（仅提供给OEM厂商） | 部分功能不支持<br />仅支持一个处理器<br />不支持虚拟环境 | 15个用户账户                     |

### 2. 系统网络架构

Windows的网络架构大致可以分为工作组（Workgroup）架构、域（Domain）架构以及前两者的混合架构。

工作组架构为分布式的管理模式，适用于小型网络；域架构为集中式的管理模式，适用于中大型网络。

#### 2.1 工作组架构的网络

工作组是由一组通过网络连接在一起的计算机所组成。

工作组网络也称为对等（peer-to-peer）网络，因为网络上每一台计算机的地位都是平等的，它们的资源与管理分散在各个计算机上。它的特性为：

1. 每一台Windows计算机都有一个本地安全账户数据库，称为Security Accounts Manager database（SAM）。用户如果想访问每一台计算机内的资源，系统管理员就必须在每一台计算机的SAM数据库内创建用户账户。
2. 工作组内可以不需要服务器等级的计算机（不需要服务器）。
3. 如果企业内部计算机数量不多（10台或20台），就可以采用工作组架构的网络。

#### 2.2 域架构的网络

域也由一组通过网络连接在一起的计算机组成。

与工作组架构不同的是，域内所有计算机共享一个集中的目录数据库（Directory Database），其中包含整个域内所有用户的账户等相关数据。这个目录数据库存储在域控制器。

域中的计算机成员如下：

1. 域控制器（Domain Controller）
2. 成员服务器（Member Server），未加域的服务器称为独立服务器（Stand-alone Server）
3. 普通计算机

windows8（Standard）计算机无法加入域。

### 3. IP地址获取失败

如果Windows Server 2012计算机的IP地址设置是采用自动获取的方式，但是却因故无法获取IP地址，此时该计算机会通过Automatic Private IP Addressing（APIPA）的机制为自己设置一个网络识别码为169.254.0.0的临时IP地址，例如169.254.49.31，不过只能够利用它来与同一个网络内的计算机通信。

## Windows Server 2012的安装

如果UPS（不间断电源供应系统）与计算机之间通过串行电缆（serial cable）串接，请拔掉这条线，因为安装程序会通过串口来检测所连接的设备，这可能会让UPS接收到自动关闭的错误指令，导致计算机断电。

带有GUI的服务器环境可以方便的与服务器核心安装环境进行切换。

## Windows Server 2012基本环境设置

### IP地址重复

如果计算机IP地址与网络上的另外一台计算机重复，计算机无法使用该地址，系统会自动分配一个169.254.0.0/16格式的IP地址给计算机使用，并且服务器管理器内会显示“多个IPv4地址”信息。网络连接详细信息如下所示：

<img src="media/2018052101.png"></img>

### Ping测试

回还测试可以检测本地计算机的网卡硬件与TCP/IP驱动程序是否可以正常接收、发送TCP/IP数据包。	

如果所Ping的计算机不存在或此计算机已经启用Windows防火墙，此时会出现**请求超时**的Ping结果返回。

### 通过代理服务器上网

为了提高上网效率与局域网的安全性，大部分企业会通过代理服务器（proxy server）上网。当用户通过代理服务器上网时，它会代替用户到网站取得所需网页对象，并将这些对象缓存（cache）到代理服务器的缓存区。以后有用户要上网访问这些相同的对象时，代理服务器就可以快速从其缓存区取得对象后传给用户的计算机，不需要再上网读取，因此可以提高访问效率。此外，代理服务器也可以提供防火墙功能，从而加强局域网的安全性。

### 启用或禁用Internet Explorer增强的安全配置

Windows Server 2012默认通过启用Internet Explorer增强的安全配置（IE ESC）来将IE的安全性级别限定为高安全性，这样做会阻挡连接绝大部分网站。

#### 禁用IE ESC

打开【服务器管理器】->【本地服务器】->右方的【IE增强的安全配置】->【关闭】

#### 查看Internet目前的安全性级别

打开【Internet选项】->【安全】

### 防火墙设置

#### 解除对某些程序的封锁

点击【允许应用程序或功能通过Windows防火墙】来解除对某些程序的封锁。

#### Windows防火墙的高级安全设置

点击【高级设置】，设置【入站规则】或者【出站规则】。

**打开Ping命令**

点击【高级设置】->【入站规则】->【文件和打印机共享（回显请求-ICMPv4-In）】，进行启用。

###环境变量

环境变量（environment variable）会影响计算机如何来运行程序、如何查找文件、如何分配内存空间等操作方式。

#### 查看现有环境变量

单击【Windows PowerShell】->进入C:\运行命令：dir env: 或 Get-Childitem env:

计算机在应用环境变量时，先应用系统变量，再应用用户变量。

#### 环境变量的使用

使用环境变量时，请在环境变量的前后加上“%”符号。

### 虚拟内存

当计算机内的物理内存（RAM）不够使用时，Windows Server 2012会通过将部分硬盘（磁盘）空间虚拟成内存，从而给应用程序或服务提供更多的内存。

### Tips

1. 如果某个设备是由系统自动检测到的，并自动安装驱动程序，虽然将该设备解除安装，但是下次重启或运行扫描检测硬件改动操作时，该设备还是会被自动检测到、安装与启用。因此，若不想使用该设备，可以采取禁用的方式，而不是卸载，或者直接拔出该设备。
2. 设置默认启动的操作系统：右击【计算机】->【属性】->【高级系统设置】->【启动和故障恢复】。
3. MMC：Microsoft Management Console，微软管理控制台。

## 本地用户和组用户的管理

### Tips

每个用户账户都有一个唯一的安全识别码（security identifier，SID），在系统内部利用SID来代表该用户。

## 创建Active Directory域

### 概念

#### 信任

两个域之间必须创建信任关系（trust relationship），才可以访问对方域内的资源。任何一个新的Active Directory域被加入到域树后，这个域会自动信任其前一层的父域，同时父域也会自动信任这个新的子域，而且这些信任关系具有双向传递性（two-way transitive）。由于这个信任工作是通过Kerberos security protocol来完成的，因此也被称为Kerberos trust。

#### 林

林（Forest）由一或数个域树组成，第一个域树的根域就是整个林的根域（forest root domain），同时其域名就是林的名称。在创建林时，每个域树的根域与林根域之间双向的、传递性的信任关系都会自动被创建。

#### 架构

Active Directory内的对象类型与属性数据定义在架构（schema）内，例如它定义了用户对象类型内包含了哪些属性，每个属性的数据类型与其范围等信息。

隶属于Schema Admins组内的用户可以修改架构内的数据，应用程序也可以自行在架构内添加其所需的对象类型或属性。在一个林内的所有域树共享相同的架构。

### LDAP

轻型目录访问协议（Lightweight Directory Access Protocol，LDAP）是一种用来查询与更新Active Directory的目录服务通信协议。

####LDAP名称路径

AD DS利用LDAP名称路径（LDAP naming path）来表示对象在Active DIrectory内的位置，并可借此访问对象。

DN：Distinguished Name，可分辨名称。表示对象在Active Directory内的完整路径。例如：CN=林晓阳,OU=业务一组,OU=业务部,DC=sayms,DC=local。

RDN：Relative Distinguished Name，用来代表DN完整路径中的部分路径。比如：CN=林晓阳或OU=业务一组。

#### 全局唯一标识符GUID

Globally Unique Identifier：GUID是一个128位的数值，系统会自动为每个对象指定一个唯一的GUID。其GUID永远不会改变。

#### 用户主体名称UPN

User Principal Name：每个用户可以有一个容易记忆的UPN，可用于登录。例如：lxy@sayms.local。

###全局编录

全局编录：global catalog，由于每个域仅存储该域本身的数据，为了让用户、应用程序能够快速找到位于其他域内的资源，在AD DS内设计了全局编录。

全局编录服务器存储着林中所有域内每个对象的**部分**属性。（常用来搜索的属性）

一个林内的所有域树共享相同的全局编录，林内的第一台域控制器默认就是全局编录服务器。

### 目录分区

Active Directory数据库被从逻辑上分为以下多个目录分区（Directory Partition）。

#### 架构目录分区

Schema Directory Partition：它存储着整个林中的所有对象与属性的定义数据，也存储着如何创建新对象与属性的规则。整个林内所有域共享一份相同的架构目录分区，它会被复制到林中所有域内的所有域控制器。

#### 结构目录分区

Configuration Directory Partition：它存储着整个AD的结构，例如有哪些域、有哪些站点、有哪些域控制器等数据。整个林共享一份相同的结构目录分区，他会被复制到林中所有域内的所有域控制器。

#### 域目录分区

Domain Directory Partition：每个域各有一个域目录分区，其中存储着与该域有关的对象，例如用户、组与计算机等对象。只会被复制到本域的所有域控制器。

#### 应用程序目录分区

Application Directory Partition：应用程序目录分区是由应用程序所创建的，其中存储着与该应用程序有关的数据。例如DNS服务器，如果创建的DNS区域为Active Directory集成区域，它就会在AD内创建应用程序目录分区，以便存储该区域的数据。只会被复制到林中的特定域控制器。

### 域控制器安装

域控制器安装成功后，可以通过检查主机记录来判断是否安装成功。

1. 检查域控制器是否已经将其主机名与IP地址注册到DNS服务器内**

点击【服务器管理器】->【工具】->【DNS】->【正向查找区域】->域名->查看是否有本机记录。

**查看SRV记录**

### 管理域组账户

#### 域内组类型

AD域内的组分为以下两种类型：

- 安全组：安全组可以被用来设置权限与权利，例如可以设置它们对文件具备读取的权限。安全组也可以用在与安全无关的工作中，例如可以给安全组发送电子邮件。
- 发布组：发布组用在与安全无关的工作中，例如你可以给发布组发送电子邮件，但是无法针对它们来设置权限与权利等安全措施。 

以组的使用范围来看，域内的组分为以下三种：

- 本地域组（domain local group）：主要用来指派其所属域内的访问权限，以便可以访问域内的资源。
  - 本地域组内的成员能够包含任何一个域内的用户、全局组、通用组；也能够包含相同的域内的本地域组；但是无法包含其他域内的本地域组。
  - 本地域组只能够访问该域内的资源，无法访问其他不同域内的资源；换句话说，当你在设置权限时，只可以设置相同域内的本地域组的权限，无法设置其他不同域内的本地域组的权限。
- 全局组（global group）：全局组主要用来组织用户，也就是你可以将多个即将被赋予相同权限的用户账户加入到同一个全局组内。
  - 全局组内的成员只能够包含相同域内的用户与全局组。
  - 全局组可以访问任何一个域内的资源，也即是说，可以在任何一个域内设置全局组的权限（这个全局组可以位于任何一个域内），以便让此全局组具备权限来访问该域内的资源。
- 通用组（universal group）：通用组可以在所有域内被设置访问权限，一边访问所有域内的资源。
  - 通用组具备“万用范围“特性，其成员能够包含林中任何一个域内的用户、全局组、通用组。但是它无法包含任何一个域内的本地域组。
  - 通用组可以访问任何一个域内的资源，也就是说，可以在任何一个域内来设置通用组的权限（这个通用组可以位于任何一个域内），以便让此通用组具备权限来访问该域内的资源。

汇总起来就是：

| 特性\组                        | 本地域组                                               | 全局组                                                     | 通用组                                                       |
| ------------------------------ | ------------------------------------------------------ | ---------------------------------------------------------- | ------------------------------------------------------------ |
| 可包含的成员                   | 所有域内的用户、全局组、通用组；相同域内的本地域组     | 相同域内的用户与全局组                                     | 所有域内的用户、全局组、通用组                               |
| 可以在哪一个域内被设置使用权限 | 同一个域                                               | 所有域                                                     | 所有域                                                       |
| 组转换                         | 可以被换成通用组（只要是原组内的成员不含本地域组即可） | 可以被转换成通用组（只要是原组不隶属于任何一个全局组即可） | 可以被转换成本地域组；可以被转换成全局组（只要是原组内的成员不含通用组即可） |

> 域用户账户与组账户也都有唯一的安全识别码（security identifier，SID）

#### AD域内置的组

AD域有许多内置组，包含本地域组、全局组、通用组与特殊组。

##### 内置的本地域组

这些本地域组本身已被赋予了一些权利与权限，以便让其具备管理AD域的能力。下面是Builtin容器内比较常用的本地域组。

- Account Operators：其成员默认可在容器与组织单元内添加/删除/修改用户、组与计算机账户，部分内置的容器例外（例如Builtin容器与Domain Controllers组织单位），同时它们也不允许在部分内置的容器内添加计算机账户（例如Users）；也无法更改大部分组的成员（例如Administrators等）。
- Administrators：其成员具备系统管理员权限，它们对所有域控制器拥有最大控制权，可以执行AD管理任务。内置系统管理员Administrator就是此组的成员，而且无法将其从此组内删除。此组默认的成员包含Administrator、全局组Domain Admins、通用组Enterprise Admins等。
- Backup Operators：其成员可以通过Windows Server Backup工具来备份与还原域控制器内的文件，不论他们是否有权限访问这些文件，其成员也可以将域控制器关机。
- Guests：其成员无法永远改变其桌面环境，当他们登录时，系统会为他们创建一个临时的用户配置文件（参见第9章的说明），而注销时此配置文件就会被删除。此组默认的成员为用户账户Guest与全局组Domain Guests。
- Network Configuration Operators：其成员可以在域控制器上执行一般网络设置任务，例如更改IP地址，但是不可以安装、删除驱动程序与服务，也不可运行服务器设置有关的任务，例如DNS域DHCP服务器的设置。
- Performance Monitor Users：其成员可以监视域控制器的运行性能。
- Print Operators：其成员可以管理域控制器上的打印机，也可以将域控制器关机。
- Remote Desktop Users：其成员可以从远程计算机通过远程桌面登录。
- Server Operators：其成员可以备份与还原域控制器内的文件；锁定与解开域控制器；将域控制器上的硬盘格式化；更改域控制器的系统时间；将域控制器关机等。
- Users：其成员仅拥有一些基本权限，例如运行应用程序，但是他们不能修改操作系统的设置、不能更改其他用户的数据、不能将服务器关机，此组默认的成员为全局组Domain Users。

##### 内置的全局组

AD有一些内置的全局组，它们本身并没有任何的权利与权限，但是可以通过将其加入到具备权利或权限的本地域组或者直接给此全局组指派权利或权限的方式让它们拥有权利或权限。这些内置的全局组位于Users容器内。如下：

- Domain Admins：域成员计算机会自动将此组加入到其本地组Administrators内，因此Domain Admins组内的每个成员，在域内的每台计算机上都具备系统管理员权限。此组默认的成员为域用户Administrator。
- Domian Computers：所有加入域的成员计算机都会被自动加入到此组内。
- Domain Controllers：域内的所有域控制器都会被自动加入到此组内。
- Domain Users：域成员计算机会自动将此组加入到其本地组Users内，因此Domain Users内的用户将享有本地组Users拥有的权利与权限，例如拥有允许本地登录的权限。此组默认的成员为域用户Administrator，而以后添加的域用户账户都自动隶属于此组。
- Domain Guests：域成员计算机会自动将此组加入到本地组Guest内。此组默认的成员为域用户账户Guest。

##### 内置的通用组

- Enterprise Admins：此组仅位于林根域，其成员有权管理林内的所有域。此组默认的成员为林根域内的用户Administrator。
- Schema Admins：此组仅为域林根域，其成员具备管理架构（schema）的权限。此组默认的成员为林根域内的用户Adminstrator。

### Active Directory回收站

旧版Windows系统中，如果系统管理员误将AD对象删除，就需要进入目录服务还原模式来救回被误删的对象。

Windows Server 2012提供了AD回收站，启用后，被删除的对象移入Deleted Objects。

### 删除域控制器与域

必须是Domain Admins或Enterprise Admins组的成员才有权限删除域控制器。

必须是Enterprise Admins组的成员，才有权限删除域内的最后一台域控制器（也就是删除域）。如果此域下还有子域，请先删除子域。

- 如果此域控制器是全局编录服务器，请检查所属站点（site）内是否还有其他全局编录服务器，如果没有，必须先指定一台域控制器来扮演全局编录服务器。

### 操作手册

#### 赋予用户在域控制器登录的权限

一般用户必须在域控制器上拥有**允许本地登录**的权限，才可以在域控制器上登录。可以通过组策略来实现。

任何域控制器上：打开【组策略管理】->【展开林】->【展开域】->【展开Domain Controllers】->选中【Default Domain Controllers Policy】->【编辑】

双击【计算机配置】->【策略】->【Windows设置】->【安全设置】->【本地策略】->【用户权限分配】->【允许本地登录】->【将用户或组加入到列表】

完成设置后，等设置应用到域控制器后生效，应用的方法有3种：

1. 将域控制器重新启动。
2. 等域控制器自动应用此新策略设置，可能需要等待5分钟或更久。
3. 手动应用：到域控制器上运行gpupdate或gpupdate/force。

如果域中有多个域控制器，则还需要等待设置值从PDC操作主机（组策略首先存储在PDC操作主机）负责到其他域控制器。分为两种情况：

1. 自动复制：PDC操作主机默认15s后会自动将其复制出去，因此其他域控制器可能需要等15s或更久才会接收到此设置值。
2. 手动复制：到Active Directory站点和服务->【Sites】->【Default-First-Site】->【Name】->【Servers】->单击要接收设置值的域控制器->【NTDS Setting】->选中服务器右键->【立即复制】

### Tips

1. 默认情况下，普通用户可登录所有的加域PC，但是无法登录所有的域控制器。
2. 域用户默认在所有非域控制器的成员计算机上具备允许本地登录的权限。

## NTFS与ReFS磁盘的安全与管理

用户必须对磁盘内的文件或文件夹拥有适当权限后，才可以访问这些资源。权限可以分为标准权限与特殊权限。其中，标准权限可以满足一般需求，而通过特殊权限可以更精确地分配权限。

以下权限仅适用于文件系统为NTFS与ReFS的磁盘，其他的exFAT、FAT32与FAT都不具备权限功能。

### 标准文件权限的种类

- 读取：可以读取文件内容、查看文件属性与权限。
- 写入：可以修改文件内容，在文件后面增加数据与改变文件属性等。
- 读取和执行：除了拥有读取的所有权限外，还具备执行应用程序的权限。
- 修改：除了拥有读取、写入与读取与执行的所有权限外，还可以删除文件。
- 完全控制：拥有前述所有权限，再加上更改权限与取得所有权的特殊权限。

### 标准文件夹权限的种类

- 读取：可以查看文件夹内的文件与子文件夹名称、查看文件夹属性与权限等。
- 写入：可以在文件夹内添加文件与子文件夹、改变文件夹属性等。
- 列出文件夹内容：除了拥有读取的所有权限之外，还具备遍历文件夹的权限，也即是可以打开或关闭此文件夹。
- 读取和执行：与列出文件夹内容相同，不过列出文件夹内容权限只会被文件夹继承，而读取和执行会同时被文件夹与文件继承。
- 修改：除了拥有前面的所有权限之外，还可以删除此文件夹。
- 完全控制：拥有前述所有权限，再加上更改权限与取得所有权的特殊权限。

### 用户的有效权限

####权限的继承性

文件夹的权限默认会被此文件夹下的子文件夹与文件继承。可以在设置文件夹权限时，单独设置继承权限。也可以在设置子文件夹或文件权限时，让子文件夹或文件不继承父文件夹的权限。

> 在安全标签中，灰色对勾表示是继承的权限。

####权限的累加性

如果用户同时隶属于多个组，而且该用户与这些组分别对某个文件（或文件夹）拥有不同的权限设置时，则该用户对这个文件的最后有效权限是所有权限来源的总和。

####“拒绝”权限的优先级比较高

虽然用户对某个文件的有效权限是所有权限来源的总和，但是只要其中有一个权限来源被设置为拒绝，则用户将不会拥有此权限。

> **继承**的权限，其优先级比直接设置的权限低。
>
> 有效权限的计算，除了用户本身的权限之外，还会将全局组、通用组、本地域组、本地组、Everyone等组的权限权限相加。但特殊组Network及Interactive除外。

###权限的分配

只有Administrators组内的成员、文件/文件夹的所有者、具备完全控制权限的用户，才有权限来分配这个文件/文件夹的权限。

####分配特殊权限

特殊权限可以更精确的分配权限。特殊权限包括：

- 遍历文件夹/执行文件：遍历文件夹让用户即使在没有权限访问文件夹的情况下，仍然可以切换到该文件夹内。此设置只适用于文件夹，不适用于文件。另外，这个权限只有用户在组策略或本地计算机策略内未被赋予绕过遍历检查权限时才有效。执行文件让用户可以执行程序，此权限适用于文件，不适用于文件夹。
- 列出文件夹/读取数据：列出文件夹让用户可以查看此文件夹内的文件名与子文件夹名，此权限只适用于文件夹。读取数据让用户可以查看文件内的数据，此权限只适用于文件。
- 读取属性：让用户可以查看文件夹或文件的属性（只读、隐藏等属性）
- 读取扩展属性：让用户可以查看文件夹或文件的扩展属性。扩展属性是由应用程序自行定义的，不同的应用程序可能有不同的扩展属性。
- 创建文件/写入文件：创建文件让用户可以在文件夹内创建文件，此权限只适用于文件夹。写入数据让用户能够修改文件内的数据或者覆盖文件的内容，此权限只适用于文件。
- 创建文件夹/附加数据：创建文件夹让用户可以在文件夹内创建子文件夹，此权限只适用于文件夹。附加数据让用户可以在文件的后面增加数据，但是无法修改、删除、覆盖原有的数据，此权限只适用于文件。
- 写入属性：让用户可以修改文件夹或文件的属性（只读、隐藏等属性）。
- 写入扩展属性：让用户可以修改文件夹或文件的扩展属性。
- 删除子文件夹及文件：让用户可删除此文件夹内的子文件夹与文件。即使用户对此子文件夹或文件没有删除的权限，也可以将其删除（见下一个权限）。
- 删除：让用户可以删除此文件夹或文件。
- 读取权限：让用户可以查看文件夹或文件的权限设置。
- 更改权限：让用户可以更改文件夹或文件的权限设置。
- 取得所有权：让用户可以夺取文件夹或文件的所有权。文件夹或文件的所有者，不论其对此文件夹或文件的权限是什么，他仍然具备更改此文件夹或文件权限的能力。

### 文件与文件夹的所有权

NTFS与ReFs磁盘内的每个文件或文件夹都有所有者，默认是创建文件或文件夹的用户。所有者可以更改其拥有的文件或文件夹的权限，不论其是否有权限访问此文件或文件夹。

用户可以夺取文件的所有权，称为新所有者，需要满足以下条件之一：

- 具备取得文件或其他对象的所有权权限的用户。系统默认赋予Administrators组拥有此权限。
- 对该文件或文件夹拥有取得所有权的特殊权限。
- 具备还原文件及目录权限的用户。

任何用户在变成文件或文件夹的新所有者后，他就具备更改该文件或文件夹权限的能力，但是并不会影响此用户的其他权限。另外，文件夹或文件的所有权被夺取后，也不会影响原所有者的其他已有权限。

> 必须在用户账户控制的通知时机被设置为不要通知并且组策略中的用户账户控制：所有系统管理员均已管理员核准模式执行策略被禁用的情况之下，才不会被要求输入系统管理员的密码。
>
> - 用户账户控制设置方法：【控制面板】->【用户账户】->【用户账户】->【更改用户账户控制设置】
> - 组策略的设置方法：【运行】->【gpedit.msc】->【计算机配置】->【Windows设置】->【安全设置】->【本地策略】->【安全选项】
>
> 完成后需要重新启动计算机。

### 文件复制或移动后的权限变化

磁盘内的文件被复制或移动到另一个文件夹后，其权限可能会改变。

- 如果文件被复制到另一个文件夹：无论是被复制到同一个或不同磁盘的另一个文件夹内，它都相当于添加一个文件，此新文件的权限是继承目的地的权限。
- 如果文件被移动到同一个磁盘的另一个文件夹
  - 如果原文件被设置为会继承父项权限：则会先删除从来源文件夹所继承的权限（但会保留非继承的权限），然后继承目的地的权限。
  - 如果原文件被设置为不会继承父项权限：则仍然保留原权限（权限不变）。
- 如果文件被移动到另一个磁盘：则此文件将继承目的地的权限。

将文件移动或复制到目的地的用户，会成为此文件的所有者。文件夹的移动或复制的原理与文件是相同的。

> 如果将文件由NTFS（或ReFS）磁盘移动或复制到FAT、FAT32或exFAT磁盘内，则原有权限设置都将被删除，因为FAT、FAT32、exFAT都不支持权限设置的功能。

如果要移动文件或文件夹（无论是移动到同一个磁盘或另一个磁盘），则必须对来源文件或文件夹具备修改的权限，同时也必须对目的文件夹具备写入的权限，因为系统在移动文件或文件夹时，它是先将文件或文件夹复制到目的文件夹（因此对它必须具备写入权限），再将源文件或文件夹删除（因此对它必须具备修改权限）。

### 文件的压缩

将文件压缩后可以减少它们占用的磁盘空间。系统支持NTFS压缩与压缩（zipped）文件夹两种不同的压缩方法，其中NTFS压缩仅NTFS磁盘支持。

压缩后权限的变化与复制或移动后权限的变化相同。

被复制到压缩文件夹内的文件都会被自动压缩。

压缩文件夹后缀.zip；压缩的方式包括：

- 右键压缩
- 【属性】->【高级】->【压缩内容以便节省磁盘空间】

### 加密文件系统

Encrypting File System，EFS。只有NTFS磁盘内的文件、文件夹才可以被加密，如果将文件复制或移动到非NTFS磁盘内，则此新文件会被解密。

> 文件压缩与文件加密无法共存。

文件加密的方法：【属性】->【高级】->【加密内容以便保护数据】。

加密面向用户是透明的。

当你将一个未加密文件移动或复制到加密文件夹后，该文件会被自动加密。当你将一个加密文件移动或复制到非加密文件夹时，该文件仍然会保持加密状态。

> 利用EFS加密的文件，只有存储在硬盘内才会被加密，通过网络发送的过程中是不会加密的。

#### 授权其他用户可以读取加密的文件

用户读取加密文件需要被授权，须具备EFS证书，一般用户在第一次执行加密操作后，就会被自动赋予EFS证书，也就可以被授权了。（EFS证书通用，但同时需要该文件同意访问）

具备恢复证书的用户也可以访问被加密的文件，默认只有域Administrator拥有恢复证书。不过，可以通过组策略或本地策略来将恢复证书指派给其他用户。本地策略操作方法：【系统管理工具】->【本地安全策略】->【公钥策略】->【加密系统】->【添加数据恢复代理程序】。

#### 备份EFS证书

可通过证书管理控制台来备份你的EFS证书：【运行】->【certmgr.msc】->【个人】->【证书】->【选中证书】->【所有任务】->【导出】。

### BitLocker驱动器加密

BitLocker驱动器加密可以将磁盘加密，以确保其中数据的安全。如果被加密保护的磁盘是Windows Server 2012操作系统磁盘，则即使它被拿到另一台计算机启动，除非已解除锁定，否则无法启动。

使用BitLocker to Go功能可以将移动磁盘加密。

> 加解密操作会增加系统负担，因此系统效率会比启用BitLocker前差。NTFS与ReFS都支持BitLocker。

#### 硬件需求

Windows Server 2012计算机内至少需要两个磁盘分区才可使用BitLocker。

- 一个用来安装Windows Server 2012操作系统的NTFS分区，可以选择是否要将此磁盘加密。
- 一个用来启动计算机的磁盘分区（容量至少需要350MB），它必须被设置为活动（active），而且它不可以被加密，如果计算机配置的是传统BIOS，则此磁盘分区必须为NTFS；如果是UEFI BIOS，则此磁盘分区必须为FAT 32。

当在一台新计算机上安装Windows Server 2012时，安装程序就会自动创建BitLocker所需的两个磁盘分区。

### 碎片整理与检查磁盘错误

磁盘使用一段时间后，存储在磁盘内的文件可能会零零散散地分布在磁盘内，从而影响到磁盘的访问效率，因此有必要整理磁盘。整理时，系统会将磁盘内的文件读出，然后重新写入到连续空间内，这样就可以提高访问效率。

> SSD的特性与一般传统硬盘不同，因此建议不要整理固态硬盘，否则数据访问将会集中在某些区域，反而会影响该区域的使用寿命。

### 磁盘配额

我们可以通过磁盘配额功能来限制用户在NTFS磁盘内的存储空间，也可以追踪每个用户的NTFS磁盘空间使用情况。通过磁盘配额的限制，可以避免用户不小心将大量文件复制到服务器的硬盘内。

## 访问网络文件

网络资源共享的方式有：公用文件夹（public folder）及共享文件夹（shared folder）。

### 公用文件夹

公用文件夹在【计算机】->【本地磁盘】->【用户】->【公用】

> 无法针对特定用户来打开公用文件夹，也就是如果不开放给网络上的所有用户，就是全部不开放。

### 共享文件夹

当将某个文件夹设置为共享文件夹后，网络上的用户就可以通过网络来访问此文件夹内的文件、子文件夹等。

#### 共享权限的种类及其具备的访问能力

| 具备的能力\权限的种类                                  | 读取 | 更改 | 完全控制 |
| ------------------------------------------------------ | ---- | ---- | -------- |
| 查看文件名称与子文件夹名称；查看文件内的数据；运行程序 | ✅    | ✅    | ✅        |
| 新建与删除文件、子文件夹；更改文件内的数据             |      | ✅    | ✅        |
| 更改权限（只适用于NTFS、ReFS内的文件或文件夹）         |      |      | ✅        |

> 共享权限只对通过网络来访问此共享文件夹的用户有约束力，若用户由本地登录，就不受此权限的约束。
>
> 位于FAT、FAT32、exFAT磁盘内的共享文件夹，由于没有ReFS、NTFS权限的保护，同时共享权限又对本地登录的用户没有约束力。此时，如果用户直接在本地登录，他将可以访问FAT、FAT32、exFAT磁盘内的所有文件与文件夹。因此，建议这种磁盘不要让用户具备允许本地登录的权限。

#### 用户的有效权限

如果网络用户同时隶属于多个组，他们分别对某个共享文件夹拥有不同的共享权限。则：

- 权限是有累加性的
- “拒绝”权限的优先级较高

#### 共享文件夹的复制与移动

如果将共享文件夹复制到其他磁盘分区内，则原始文件夹仍然保留共享状态，但是复制的那一份新文件夹并不会被设置为共享文件夹。如果将共享文件夹移动到其他磁盘分区内，则此文件夹将不再是共享文件夹。

#### 与NTFS（或ReFS）权限搭配使用

如果共享文件夹位于NTFS（或ReFS）磁盘内，那么还可以设置此文件夹的NTFS权限，以便能够更进一步增强其安全性。

> 最后的权限=网络共享权限+NTFS（ReFS）权限中 **最严格（most restrictive） ** 的设置。 

#### 共享文件夹的新建与管理

隶属于Administrators组的用户具备将文件夹设置为共享文件夹的权限。

第一次将文件夹共享后，系统会启用文件和打印机共享。【控制面板】->【网络和Internet】->【网络和共享中心】-> 【更改高级共享设置】

#### 共享文件夹的停止共享与更改使用权限

【右键】->【共享】->【停止共享】\【更改共享权限】

#### 添加共享名

每个共享文件夹都有共享名，网络上的用户通过共享名来访问共享文件夹内的文件，共享名默认就是文件夹名称。也可以添加多个共享名。【高级选项】->【添加共享名】

#### 隐藏共享文件夹

如果不想让用户在网络上浏览到它，只要在共享名最后加上一个符号$，就可以将其隐藏起来。添加新共享名，删除旧共享名。

#### 共享文件夹的管理

【系统管理工具】->【计算机管理】->【系统工具】->【共享文件夹】->【共享】来管理共享文件夹。

如果有权限，可以通过右击【计算机管理（本地）】->【连接到另一台计算机】

> 请不要将系统自动创建的隐藏共享文件夹通知共享，否则可能会影响系统的正常运行。即使将其停用，下次启动计算机时，系统会自动将它们共享。

点击会话后，就可以查看与管理已经连接到此计算机的用户了。

连接共享时，如果网络计算机内并没有为你创建一个名称相同的用户账户：

- 如果该网络计算机已经启用guest账户，则系统会自动为你利用guest身份连续。
- 如果该网络计算机禁用guest账户（默认值），则系统会要求你重新输入用户名与密码。

记住的凭据可以在【控制面板】->【用户账户和家庭安全】->【凭据管理器】->【管理Windows凭据】来管理。

#### 脱机访问

在外网访问内网的共享文件，可在连接情况下连接到网络计算机，并将所选文件设置为始终脱机可用，之后这个文件将被复制到计算机的硬盘内。脱机时，如仍连接共享文件，则优先使用共享文件。

当计算机恢复与网络计算机连接后，网络文件与缓存文件之间必须同步，以确保两处的文件是一致的：

- 如果更改过缓存文件的内容，但是网络文件的内容并没有被更改过，则系统会将缓存文件复制到网络计算机，并覆盖网络文件。
- 如果你并未更改缓存文件的内容，但是网络文件的内容被更改过，则系统会将网络文件复制到本地计算机，并覆盖缓存文件。
- 如果网络文件与缓存文件都被更改过，则系统会让你选择保留哪一个文件，或将两个文件都保留。

右键->【始终脱机使用】

脱机后，与服务器不是随时同步的，需要选中文件->【同步】->【同步所选脱机文件】

若计算机与服务器连接速度很慢，大部分客户端会自动切换到脱机模式，连接恢复后，自动切换为连接模式。

#### 服务器端的脱机文件设置

可在【共享文件】->【属性】->【高级共享】->【缓存】

- 选择【进行性能优化】后会自动将程序（.exe或.dll）缓存到用户的硬盘内，以便用户要运行网络计算机内的程序时，可以直接读取缓存版本，它可以减少网络负荷、加快程序的运行。此选项特别适合于存放应用程序的服务器使用。

#### 卷影副本（shadow copies of shared folder）

可以通过共享文件夹的卷影副本功能，让系统自动在指定时间将所有共享文件夹内的文件复制到另一个存储区备用，这个存储区称为卷影副本存储器。

如果用户将共享文件夹内的文件误删或误改文件内容后，想要救回文件或还原文件内容，可以通过卷影副本存储区的内的备份文件来达到目的。

#### 服务器启用“共享文件夹的卷影副本”功能

【计算机】->【任意磁盘右键】->【属性】->【卷影副本】->【启用】

> 系统默认将卷影副本存储区创建在启用卷影副本的磁盘内，但这不是最佳作法，因为会增加该磁盘的负担、降低系统效率，最好是将卷影副本存储区创建到另一个未启用卷影副本的磁盘内。
>
> 卷影副本内的文件只可读取，不可修改，而且每个磁盘最多只可以有64个卷影副本。如果超出此限制，最旧的卷影副本会被删除。

## 打印服务器的设置与管理

打印机驱动程序：打印服务器接收到用户送来的打印文档后，打印机驱动程序就负责将文档转换为打印设备能够识别的格式，然后送往打印设备打印。不同型号的打印设备各有其不同的打印机驱动程序。

## 组策略

组策略可以让系统管理员充分管理用户工作环境，通过它来确保用户拥有应有的工作环境，也通过它来限制用户。

组策略的分类：

- 计算机配置：仅对计算机环境产生影响；
- 用户配置：只对用户环境有影响。

设置组策略的方法有：

- 本地计算机策略：设置单一计算机的策略，该策略内的计算机配置只会被应用的这台计算机，而用户设置会被应用到在此计算机登录的所有用户；
- 域的组策略：在域内可针对站点、域或组织单位来设置组策略，其中，域组策略内的设置会被应用到域内的所有计算机与用户，而组织单位的组策略会被应用到该组织单位内的所有计算机与用户。

> 如果本地计算机策略的设置与域或组织单位的组策略设置发生冲突，则域或组织单位组策略的优先级更高。
>
> 如果域组策略与组织单位组策略发生冲突，则组织单位组策略优先级更高。

####本地组策略配置

【运行】->【gpedit.msc】进入本地组策略编辑器。

####域组策略配置

域组策略是通过GPO（Group Policy Object，组策略对象）进行设置的，当将GPO链接（link）到域sayms.local或组织单位后，此GPO设置值就会被应用到域sayms.local或组织单位内的所有用户与计算机。系统已经内置了两个GPO，分别为如下所示：

- Default Domain Policy：此GPO已经被连接到域sayms.local，因此这个GPO内的设置值会被应用到域sayms.local内的所有用户与计算机。
- Default Domain Controllers Policy：此GPO已经被连接到组织单位Domain Controllers，因此这个GPO的设置值会被应用到Domain Controllers内的所有用户与计算机。Domain Controllers内默认只有扮演域控制器角色的计算机。

> 多个GPO应用到一个域或组织单元时，这些GPO的设置会合并起来应用到组织单元或域的所有用户与计算机。如果发生冲突，排列在前面的优先级更高。

【运行】->【组策略管理】

阻止继承：表示不要继承域策略设置。

强制：其下的组织必须继承此GPO，无论是否选择组织继承。

更改策略后强制应用：gpupdate/force

## 注册表与注册编辑器

注册表（registry）是保存计算机软硬件设置值的重要数据库。包括：

- 系统核心设置
- 硬件设备的相关设置，如硬件中断、DMA信道、I/O地址等。
- 通信协议的设置
- 服务设置
- 应用程序的设置

注册表编辑器REGEDIT.EXE是一个高级工具程序，可以利用它来查看与更改系统的注册表值，以便改变系统或应用程序的运行方式。

#### 注册表的架构

注册表的架构：

- 子树目录：这个结构就好像是磁盘内的跟文件夹（root folder）。
- 键与子键：键与子键的结构好像是文件夹与子文件夹之间的关系。在键下可以包含数值与其他子键。
- 数值：每一条数值内包含3部分，即数值名称、数值的数据类型和数值数据。

Windows Server 2012目前支持的数据类型如下表：

| 数据类型      | 说明                                                         |
| ------------- | ------------------------------------------------------------ |
| REG_SZ        | 单一字符串                                                   |
| REG_MULTI_SZ  | 多重字符串                                                   |
| REG_BINARY    | 二进制值。大部分与硬件组件有关的数据都是以二进制的形式进行保存的 |
| REG_DWORD     | 32位的数值                                                   |
| REG_QWORD     | 64位的数值                                                   |
| REG_EXPAND_SZ | 包含变量（例如%systemroot%）的字符串                         |



## 使用Hyper-V进行服务器虚拟化

如果想深入了解Hyper-V，可查看Sybex公司的Windows Server 2012 Hyper-V Installation and Configuration Guide这本书。

### 服务器虚拟化

服务器虚拟化就是在一台主机上，通过一些手段运行多个虚拟机。虚拟化可以帮助解决资源的浪费现象。虚拟化后通过合适的软件，可以在物理服务器之间轻松地移动虚拟服务器。

考虑Hyper-V的网络性能，通常建议至少拥有两个NIC，一个用来管理主机，另一个用于VM访问网络。

### 硬件要求

1. CPU必须是64位
2. 必须支持**硬件辅助虚拟化技术**（Hardware-assisted Virtualization），也就是CPU必须支持Intel VT（Intel Virtualization Technology）或AMD-V（AMD Virtualization），并且需要在主板的BIOS内启用。
3. 必须启用**硬件数据执行保护**（hardware data execution protection），也就是必须启用Intel XD bit（Execute Disable Bit）或AMD NX bit（No Execute Bit），并且主板BIOS必须启用Intel XD或AMD NX。

### Hyper-V的虚拟交换机

通过Hyper-V可以创建以下三种类型的虚拟交换机：

- 外部虚拟交换机：此虚拟交换机所在的网络就是主机物理网卡所连接的网络，因此你所创建的虚拟机的网卡如果被连接到这个外部虚拟交换机，则它们可以通过此交换机与主机通信，也可以与连接在这个交换机上的其他计算机通信，甚至可以连接Internet。如果主机有多块物理网卡，则你可以针对每块网卡创建一个外部虚拟交换机。
- 内部虚拟交换机：连接在内部虚拟交换机上的计算机之间可以相互通信，也可以与主机通信，但是无法与其他网络内的计算机通信，同时他们也无法连接Internet。除非在主机上启用NAT或路由，例如启用Internet连接共享（ICS）。可以创建多个内部虚拟交换机。
- 专用虚拟交换机：连接在这个专用虚拟交换机上的计算机之间可以互相通信，但是并不能与主机通信，也无法与其他网络内的计算机通信。可以创建多个专用虚拟交换机。

### 差异虚拟硬盘

使用一个虚拟机作为母盘，以此母盘为基准创建差异虚拟硬盘，将差异虚拟硬盘分配给新的虚拟机使用。启动新的虚拟机时，仍会使用母盘，但是任何改动都只会被存储到虚拟差异硬盘。

母盘模式下，如果使用母盘的虚拟机被启动，则其他使用差异虚拟硬盘的虚拟机将无法启动。如果母盘文件发生故障或丢失，则其他使用差异虚拟硬盘的虚拟机也无法启动。

### Tips

1. SAN：storage area network，存储区域网络。
2. Hyper-V 第二代虚拟机支持win 8或win server 2012以上系统。













